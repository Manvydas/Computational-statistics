---
title: "Project I"
author: "Manvydas Sokolovas, p3170190"
date: "11/28/2017"
output:
  pdf_document:
    latex_engine: xelatex
    number_section: yes
    toc_depth: 2
  html_document: default
---

```{r, include=FALSE}
library(truncnorm)
library(dplyr)
library(knitr)
```
```{r, include=FALSE}
# function to generate data and get the price per customer
cost <- function(){
  components <- sample(1:2, prob = c(0.625, 0.375), size = n, replace=TRUE) # probability of the first car is n/1.6n = 0.625, second 0.6n/1.6n = 0.375
  mus <- c(16, 8) # averages of mileages
  sds <- sqrt(c(2.5, 8)) # standar dev. of mileages
  mileage <- rtruncnorm(n = n, mean = mus[components], sd = sds[components], a = 0)
  
  first_dam <- rexp(n, 0.05) # Months till first damage. mean = 1/0.05=20

  dam_size <- rgamma(n, shape = 1, scale = 100) # mean = a*s = 1*100 =100 , var = a*s^2 = 1*100^2 = 10000

  dat <- data.frame(mileage, first_dam, dam_size) # connecting vectors into data frame

  dam1 <- dat[(dat$first_dam<=12),] # excluding damages after 12 moths
  car <- dam1[(dam1[,1]<=14),] # excluding cars with mileage over 14k kilometers
  loss <- sum(car[,3]) # total damage
  price <- loss/n # dividing total damage from total clients number
  round(price,2)
}
```

\section*{Introduction}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The task required to calculate the price of insurance based on given information about customers - distributions of car's mileage, time till first damage and the size of damage.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Data was generated by given distributions. It was chosen to sample Cars' mileages from a mixture of Normal distributions: $0.625\!\times\mathcal{N}(16,2.5)\; + \;0.375\!\times\mathcal{N}(8,8)$. After excluding clients who did not fit criterias, price of insurance was calculated by dividing sum of damages from a number of all customers.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Task was divided in four parts by number of customers. Simulations were repeated 1000 times for each part. 95% quantile was taken to lower the chance of deficit to 5%.

# Case of 10 clients

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Simulation of insurance price if firm have only 10 customers was replicated 1000 times. The histogram below shows distribution of prices. The price looks really wide distributed. This could be because of a low customers number.
```{r, include=FALSE}
n <- 10
sim1 <- replicate(1000, cost())
sd(sim1)
```

```{r, echo=FALSE}
hist(sim1, main = "Frequency of Prices ", cex.main = 1, xlab = "Price")
sd1 <- round(sd(sim1), 2)
price1 <- round(quantile(sim1, 0.95), 2)
summ1 <- summary(sim1)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 95% quantile suggest that the price should be `r price1`. Standart deviation is `r sd1`. It is pretty big and price distribution looks volatile. Thus, it is hard to predict price very accurate.

\newpage

# Case of 1000 clients

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Simulation of insurance price if firm have 1000 customers was repeated 1000 times. The histogram below shows distribution of prices. The price looks more concentrated. Variance should not be high.
```{r, include=FALSE}
n <- 1000
sim2 <- replicate(1000, cost())
```

```{r, echo=FALSE}
hist(sim2, main = "Frequency of Prices ", cex.main = 1, xlab = "Price")
sd2 <- round(sd(sim2), 2)
price2 <- round(quantile(sim2, 0.95), 2)
summ2 <- summary(sim2)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The price with 5% chance of deficit is `r price2`. It is `r round(price2/mean(sim2), 2)` times the average price and this is `r round((price2-mean(sim2))/sd2, 2)` standart deviation units from average. Standart deviation is `r sd2`. Results looks more reliable compared to 10 clients case. It could be because of clients number. When firm have more customers it is bigger chance to have bigger expenses. But on the other hand with more clients firm get consistency. Higher sales of insurance cover clients with damaged cars. 

\newpage

# The number of clients follows a Poisson distribution with mean 10
```{r, include=FALSE}
# Same function. Just added clients number inside function
cost3 <- function(){
  n <- rpois(1, 10) # clients number 
  
  components <- sample(1:2, prob = c(0.625, 0.375), size = n, replace=TRUE)
  mus <- c(16, 8)
  sds <- sqrt(c(2.5, 8))
  mileage <- rtruncnorm(n = n, mean = mus[components], sd = sds[components], a = 0)
  first_dam <- rexp(n, 0.05)
  dam_size <- rgamma(n, shape = 1, scale = 100)
  dat <- data.frame(mileage, first_dam, dam_size)
  dam1 <- dat[(dat$first_dam<=12),]
  car <- dam1[(dam1[,1]<=14),]
  loss <- sum(car[,3])
  price <- loss/n
  price
}
```
```{r, echo=FALSE}
sim3 <- replicate(1000, cost3())
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Simulation of insurance price if number of customers follows a Poisson distribution with mean 10 was replicated 1000 times. The histogram below shows distribution of prices. Price looks really wide distributed but the most of observations are concentrated in lower intervals. This could be because of a low customers number and added randomnes by clients number.

```{r, echo=FALSE}
hist(sim3, main = "Frequency of Prices ", cex.main = 1, xlab = "Price")
sd3 <- round(sd(sim3), 2)
price3 <- round(quantile(sim3, 0.95), 2)
summ3 <- summary(sim3)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The price with 5% chance of deficit is `r price3`. Standart deviation is `r sd3`. Results from this part looks the most volatile.

\newpage

# The number of clients follows a Poisson distribution with mean 1000

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Simulation of insurance price if number of customers follows a Poisson distribution with mean 1000 was repeated 1000 times The histogram below shows distribution of prices. The price looks concentrated around the mean. Variance should not be high. 
```{r, include=FALSE}
cost4 <- function(){
  n <- rpois(1, 1000) # clients number 
  
  components <- sample(1:2, prob = c(0.625, 0.375), size = n, replace=TRUE)
  mus <- c(16, 8)
  sds <- sqrt(c(2.5, 8))
  mileage <- rtruncnorm(n = n, mean = mus[components], sd = sds[components], a = 0)
  first_dam <- rexp(n, 0.05)
  dam_size <- rgamma(n, shape = 1, scale = 100)
  dat <- data.frame(mileage, first_dam, dam_size)
  dam1 <- dat[(dat$first_dam<=12),]
  car <- dam1[(dam1[,1]<=14),]
  loss <- sum(car[,3])
  price <- loss/n
  price
}
```
```{r, echo=FALSE}
sim4 <- replicate(1000, cost4())
```

```{r, echo=FALSE}
hist(sim4, main = "Frequency of Prices ", cex.main = 1, xlab = "Price")
sd4 <- round(sd(sim4), 2)
price4 <- round(quantile(sim4, 0.95), 2)
summ4 <- summary(sim4)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The price with 5% chance of deficit is `r price4`. Standart deviation is `r sd4`. Results looks more consistent compared to 1 and 3 cases. Compared to 2nd case: variance is higher because clients number is random number.

\newpage

# Results

```{r, echo=FALSE}
plot(c(0,1000),c(0,max(sim1, sim2, sim3, sim4)), type="n", xlab = "", ylab = "Price", main = "")
lines(sort(sim1), lwd = 2.5)
lines(sort(sim2), col = 4, lwd = 2.5)
lines(sort(sim3), col = 3, lwd = 2.5, lty = 3)
lines(sort(sim4), col = 2, lwd = 2.5, lty = 3)
legend(1, max(sim1, sim2, sim3, sim4), legend = c("10 clients", "1000 clients", "Poisson with mean 10", "Poisson with mean 1000"),
       col = c(1,4,3,2), lwd = 2, lty=c(1,1,3,3), cex=0.7)

plot(c(0,1000),c(min(sim2, sim4),max(sim2, sim4)), type="n", xlab = "", ylab = "Price", main = "1000 vs Poisson with mean 1000", cex.main = 1)
lines(sort(sim2), col = 4, lwd = 2.5)
lines(sort(sim4), col = 2, lwd = 2.5, lty = 3)
legend(1, max(sim2, sim4), legend = c( "1000 clients", "Poisson with mean 1000"),
       col = c(4,2), lwd = 2, lty=c(1,33), cex=0.7)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; When number of clients is similar then lines almost cover each other. Prices without constant customers number are fluctuating a bit more. Thus, clients number is a game changer. When the firm has more customers then incurred losses are covered better. And if the firm has a small number of clients any bigger deviation can cause a big loss.
